<!DOCTYPE HTML>
<html>
<head>
<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!------ Include the above in your HEAD tag ---------->
<link href="/static/chat.css" type="text/css" rel="stylesheet">
<link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" type="text/css" rel="stylesheet">
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.min.js"></script>
<script>
	var uuid = getCookie("uuid");
	var userid = getCookie("userid");
	var focusedUser = null;
	var sock = io.connect('ws://127.0.0.1:9090/');

	function getlist(){
		// get chatting lists
		$.ajax({
			type: "GET",
			url: "/getlist",
			dataType: "json",
			error: function() {
				return false;
			},
			success: function(datas) {
				var appendHTML = "";
				var cnt = 0;
				for (var data of datas["result"]) {
					var active_chat = "";
					if (cnt == 0) { active_chat = "active_chat"; }
					appendHTML += `<div class="chat_list ${data.id} ${active_chat}" onclick=getmessage("${data.id}")>
		              <div class="chat_people">
		                <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png" alt="sunil"> </div>
		                <div class="chat_ib">
		                  <h5>${data.id}<span class="chat_date">${data.date}</span></h5>
		                  <p>${data.text}</p>
		                </div>
		              </div>
		            </div>
		            `
				  	cnt += 1;
				}
				$(".inbox_chat").html(appendHTML);
				$(".active_chat").click();
				return true;
			}
		});
	}

	function getDateStr(strdate){
		date = new Date(strdate);
		return `${date.getHours().toString().padStart(2,"0")}:${date.getMinutes().toString().padStart(2,"0")} | ${date.toDateString().split(" ")[1]} ${date.getDate()}`
	}

	function getRandomSID(){
		var sid = ""
		for(var i=0; i<32; i++){
			sid += Math.floor(Math.random()*16).toString(16)
		}
		return sid
	}

	function appendMessages(data){
		console.log("called")
		var appendHTML = "";			
		var datestr = getDateStr(data.date)
		
		if (data.to == userid && data.to != data.from){
			appendHTML += `<div class="incoming_msg">
              <div class="incoming_msg_img"> <img src="https://ptetutorials.com/images/user-profile.png" alt="sunil"> </div>
              <div class="received_msg">
                <div class="received_withd_msg">
                  <p>${data.msg}</p>
                  <span class="time_date"> ${datestr}</span></div>
              </div>
            </div>
            `
    } else if (data.from == userid || data.from == data.to) {
    	appendHTML += `<div class="outgoing_msg">
          <div class="sent_msg">
            <p>${data.msg}</p>
            <span class="time_date"> ${datestr}</span> </div>
        </div>
        `
    } else {
    	console.log("[x] ?? what's going on?");
    }
	  	
		
		$(".msg_history").append(appendHTML);
		$(".msg_history").scrollTop($(".msg_history")[0].scrollHeight);
	}

	function getchatmsg(id){
		// get chatting messages
		$.ajax({
			type: "POST",
			url: `/chat`,
			dataType: "json",
			data: {"mode":"getchatmsg","id":id},
			error: function() {
				return false;
			},
			success: function(datas) {
				var appendHTML = "";
				var cnt = 0;
				
				for (var data of datas["result"]) {
					var datestr = getDateStr(data.date)

					if (data.from == userid) {
	        	appendHTML += `<div class="outgoing_msg">
	              <div class="sent_msg">
	                <p>${data.msg}</p>
	                <span class="time_date"> ${datestr}</span> </div>
	            </div>
	            `
	        } else if (data.to == userid){
						appendHTML += `<div class="incoming_msg">
			              <div class="incoming_msg_img"> <img src="https://ptetutorials.com/images/user-profile.png" alt="sunil"> </div>
			              <div class="received_msg">
			                <div class="received_withd_msg">
			                  <p>${data.msg}</p>
			                  <span class="time_date"> ${datestr}</span></div>
			              </div>
			            </div>
			            `
	        }  else {
	        	console.log("[x] ?? what's going on?");
	        }
				  	
				}
				$(".msg_history").html(appendHTML);
				$(".msg_history").scrollTop($(".msg_history")[0].scrollHeight);
				return true;
			}
		});
	}

	function getmessage(id){
		focusedUser = id;
		$(".active_chat").attr("class", $(".active_chat").attr("class").replace(" active_chat",""));
		$(`.chat_list.${id}`).attr("class",`chat_list ${id} active_chat`);
		if(getchatmsg(id) == false){
			alert("getchatmsg error");
		}
		$("#sendto").val(id);
	}

  function getCookie(name) {
      var value = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
      return value? value[2] : null;
  }

  function maketime(){
  	var date = new Date().toISOString();
  	var a = date.split('T')[0];
  	var b = date.split('T')[1].split('.')[0];
  	return `${a} ${b}`
  }

	

	$(document).ready(function(){
		
		window.onbeforeunload = function(e) {
		  sock.disconnect();
		};

		sock.on('connect', function(){
			var data = {'channel':uuid, 'userid':userid};
			sock.emit("join",data);
		});

		sock.on('join', function(data){
			console.log("[+] join "+data);
			if(data["result"] == "fail"){
				alert("join room fail")
			}
		})

		// when get a new chat message
		sock.on('newchat', function(data){
			if(data.result == 0){
				console.log("[x] err... "+data.msg);
			}else if(data.result == 1 && focusedUser == data.msg.from){
				console.log(`[+] newchat ${data.msg.from}->${data.msg.to} : ${data.msg.msg}`);
				appendMessages(data.msg);
			}
		})

		if(getlist() == false){
			alert("getlist error");
		}

		$("#sendform").submit(function(event){
			event.preventDefault();
			var data = {
				"command": "chatsend",
				"date": maketime(),
				"from": userid,
				"to": $("input[name=to]").val(),
				"msg": $("input[name=msg]").val()
			};
			
			if(data.msg.length > 1000){
				alert("[x] msg length is too long");
				return false;
			}

			if(data["to"] == userid){
				data["sendtome"] = 'true';
			}
			
			sock.emit("chatsend", data);
			
			$(".write_msg").val("");
				setTimeout(getchatmsg,300,focusedUser)
			})

		$("#uploadImage").click(function(e){
			e.preventDefault();
			$("#file1").click();
		})

	});

	function doUpload(fis){
		var form = $("#uploadImageForm")[0];
		var data = {
			"command": "imagesend",
			"date": maketime(),
			"from": userid,
			"to": $("input[name=to]").val(),
			"msg": $("input[name=msg]").val()
		};
		sock.emit("chatsend", data);

		// var formData = new FormData(form);
		// formData.append("image", $("#file1")[0].files[0]);

		// $.ajax({
		// 	url: 'uploadImage',
		// 	processData: false,
		// 	contentType: false,
		// 	data: formData,
		// 	type: 'POST',
		// 	success: function(result){
		// 		console.log(result);
		// 	}
		// });
	}

</script>
</head>
<body>
<div class="container">
<h3 class=" text-center">FSI CHAT SERVICE</h3>
<div class="top_bar">
	<a href="/logout">logout</a>
</div>
<div class="messaging">
      <div class="inbox_msg">
        <div class="inbox_people">
          <div class="headind_srch">
            <div class="recent_heading">
              <h4>Recent</h4>
            </div>
          </div>
          <div class="inbox_chat">
            
          </div>
        </div>
        <div class="mesgs">
          <div class="msg_history">
            
           
          </div>
          <div class="type_msg">
          	<div class="input_file">
		          		<img src="/static/uploadicon.png" id="uploadImage">
		          		<form id="uploadImageForm" action="/uploadImage" method="POST" enctype="multipart/form-data">
		          			<input id="file1" type="file" name="image" style="display:none;" onchange="doUpload(this)">
		          		</form>
		        </div>
            <div class="input_msg_write">
              <form id="sendform">
                <input type="text" class="write_msg" name="msg" placeholder="Type a message" />
                <input type="hidden" id="sendto" name="to" value="">
                <button class="msg_send_btn" type="submit"><i class="fa fa-paper-plane-o" aria-hidden="true"></i></button>
              </form>
            </div>
          </div>
        </div>
      </div>
      
</div></div>
</body>
</html>